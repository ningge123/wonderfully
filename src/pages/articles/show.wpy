<template>
    <view class="container">
        <view class="page-body" style="margin-bottom: 100px">
            <view class="page__bd">
                <view class="article">
                    <view class="zan-font-16 zan-font-bold">{{ article.title }}</view>
                    <view class="media-box__info">
                        <view class="media-box__info__meta" wx:if="{{ article.is_original }}">åŸåˆ›</view>
                        <view class="media-box__info__meta">{{ article.user.name }}</view>
                        <view class="media-box__info__meta media-box__info__meta_extra">{{ article.published_time }}</view>
                    </view>
                    <view class="media-box__body">
                        <import src="/markdown/entry.wxml"/>
                        <template is="entry" data="{{...article.content}}"/>
                    </view>
                </view>
                <view style="padding: 0 10px">
                    <view class="resp-head">å…¨éƒ¨å›å¤ï¼ˆ{{ article.comments_count }}ï¼‰</view>
                    <repeat for="{{ comments }}" key="" index="index" item="comment">
                        <view class="article">
                            <view class="article-info">
                                <view class="article-author">
                                    <navigator url="/pages/user/me?name={{ comment.reply_user.name }}" hover-class="none">
                                        <view>
                                            <image class="article-author-icon" src="{{ image_url + comment.reply_user.avatar }}"/>
                                        </view>
                                    </navigator>
                                    <view class="article-author-info">
                                        <view>{{  comment.reply_user.name }}</view>
                                        <view>{{ comment.created_at.created_diff }}</view>
                                    </view>
                                </view>
                                <view class="article-author-position">
                                    <view>{{ index + 1 }}æ¥¼</view>
                                </view>
                            </view>
                            <view>
                                <view class="zan-c-red" wx:if="{{ comment.parent_id }}">
                                    @{{ comment.user.name }}
                                </view>
                                <import src="/markdown/entry.wxml"/>
                                <template is="entry" data="{{...comment.content.raw}}"/>

                            </view>
                        </view>
                    </repeat>
                </view>
            </view>
        </view>
        <view class="page-tail">
            <block wx:if="{{ user }}">
                <view class="resp-input-cell">
                    <input class="resp-input" type="text" value="{{ message }}" placeholder="è¯´ç‚¹ä»€ä¹ˆå§..." bindinput="bindCommentMessageInput"/>
                </view>

                <view class="resp-btn" @tap="submit">å›å¤</view>
            </block>
            <navigator wx:else class="need-login" url="/pages/auth/login">ç‚¹æ­¤å¤„ç™»å½•ä¹‹åï¼Œå³å¯å›å¤æ–‡ç« ğŸ˜†</navigator>
        </view>
    </view>
</template>

<script>
    import wepy from 'wepy'
    import api from '@/utils/api'
    import {imageUrl} from "../../utils/image";

    export default class Show extends wepy.page {
        config = {
            navigationBarTitleText: 'æ–‡ç« è¯¦æƒ…'
        }
        data = {
            article : {},
            comments: [],
            image_url : '',
            user : null,
            message: ''
        }
        async submit(e) {
           if (! this.message) {
               return
           }

            try {
                // è¯·æ±‚å‘å¸ƒå›å¤æ¥å£
                let createResponse = await api.request({
                    url: 'comments',
                    method: 'POST',
                    data: {
                        content: this.message,
                        commentable_id: this.article.id,
                        commentable_type: 'article',
                    },
                    header: {
                        'X-Requested-With': 'XMLHttpRequest'
                    }
                })

                if (createResponse.statusCode === 200) {
                    let comment = createResponse.data.data
                    const Towxml = require('towxml')
                    const towxml = new Towxml();
                    //å°†æ–‡ä»¶è½¬æ¢æˆä¸ºtowxmlæ”¯æŒçš„jsonæ•°æ®
                    comment.content.raw = towxml.toJson(comment.content.raw, 'markdown');

                    this.comments.push(comment)
                    this.message = ''
                    this.$apply()
                }

                // æç¤ºå‘å¸ƒæˆåŠŸ
                wepy.showToast({
                    title: 'è¯„è®ºæˆåŠŸ',
                    icon: 'success'
                })
            } catch (err) {
                console.log(err)
                wepy.showModal({
                    title: 'æç¤º',
                    content: 'æœåŠ¡å™¨é”™è¯¯ï¼Œè¯·è”ç³»ç®¡ç†å‘˜'
                })
            }
        }
        // è·å–æ–‡ç« æ•°æ®
        async getArticle(slug){
            try {
                let articleResponse = await api.request({
                    url: 'articles/' + slug,
                    header: {
                        'X-Requested-With': 'XMLHttpRequest'
                    }
                })
                let article = articleResponse.data.data
                const Towxml = require('towxml')
                const towxml = new Towxml();
                //å°†æ–‡ä»¶è½¬æ¢æˆä¸ºtowxmlæ”¯æŒçš„jsonæ•°æ®
                article.content = towxml.toJson(article.content, 'markdown');

                this.article = article
                if (article.comments_count) {
                    let commentsResponse = await
                    api.request({
                        url: 'commentable/' + article.id + '/wx_comment',
                        header: {
                            'X-Requested-With': 'XMLHttpRequest'
                        }
                    })
                    let comments = commentsResponse.data.data

                    for (let i = 0; i < comments.length; i++) {
                        comments[i].content.raw = towxml.toJson(comments[i].content.raw, 'markdown');
                    }
                    this.comments = comments
                }

                this.$apply()
            } catch (err) {
                console.log(err)
                wepy.showModal({
                    title: 'æç¤º',
                    content: 'æœåŠ¡å™¨é”™è¯¯ï¼Œè¯·è”ç³»ç®¡ç†å‘˜'
                })
            }
         }
         methods = {
             bindCommentMessageInput(e) {
                 this.message = e.detail.value
             }
         }
        async onLoad(options) {
            this.getArticle(options.slug)
            this.image_url = imageUrl
            // è·å–å½“å‰ç”¨æˆ·ä¿¡æ¯
            this.user = await this.$parent.getCurrentUser()
            this.$apply()
        }
        onShareAppMessage (res) {
            return {
                // æ ‡é¢˜æ˜¯è¯é¢˜æ ‡é¢˜
                title: this.article.title,
                // è·¯å¾„ä¸ºè¯é¢˜è¯¦æƒ…è·¯å¾„
                path: '/pages/articles/show?slug=' + this.article.slug,
                imageUrl: this.image_url + this.article.share_wx_image,
            }
        }
    }
</script>

<style>
    @import '/markdown/style/main.wxss';
    @import '/markdown/style/light.wxss';
    @import "/style/detail.wxss";
    .article-author-icon{
        width:320px;
        height:240px;
        display:inline-block;
        overflow:hidden;
        vertical-align: text-bottom;
        margin:0;
        border-radius:10%;

    }

</style>
